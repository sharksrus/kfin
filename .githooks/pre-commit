#!/usr/bin/env sh
set -eu

if ! command -v gofmt >/dev/null 2>&1; then
  echo "pre-commit: gofmt not found; install Go to continue."
  exit 1
fi

changed_go_files="$(git diff --cached --name-only --diff-filter=ACMR | grep '\.go$' || true)"
if [ -z "${changed_go_files}" ]; then
  exit 0
fi

echo "pre-commit: running gofmt on staged Go files..."

# Apply formatting to working tree files.
echo "${changed_go_files}" | xargs gofmt -w

# Restage formatted files.
echo "${changed_go_files}" | xargs git add

# Guardrail: fail if anything still reports as unformatted.
unformatted="$(gofmt -l ${changed_go_files} || true)"
if [ -n "${unformatted}" ]; then
  echo "pre-commit: files are still unformatted:"
  echo "${unformatted}"
  exit 1
fi

exit 0

